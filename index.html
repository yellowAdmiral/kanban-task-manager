<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        import React, { useState, useEffect } from 'react';
import { Plus, X, ChevronDown, ChevronRight, Clock, Tag, User, Share2, Trash2 } from 'lucide-react';

const COLORS = [
  { name: 'Red', value: 'bg-red-100 border-red-300 text-red-800' },
  { name: 'Orange', value: 'bg-orange-100 border-orange-300 text-orange-800' },
  { name: 'Yellow', value: 'bg-yellow-100 border-yellow-300 text-yellow-800' },
  { name: 'Green', value: 'bg-green-100 border-green-300 text-green-800' },
  { name: 'Blue', value: 'bg-blue-100 border-blue-300 text-blue-800' },
  { name: 'Purple', value: 'bg-purple-100 border-purple-300 text-purple-800' },
  { name: 'Pink', value: 'bg-pink-100 border-pink-300 text-pink-800' },
  { name: 'Gray', value: 'bg-gray-100 border-gray-300 text-gray-800' }
];

export default function TaskTracker() {
  const [boards, setBoards] = useState([]);
  const [newBoardName, setNewBoardName] = useState('');
  const [selectedTask, setSelectedTask] = useState(null);
  const [username, setUsername] = useState('');
  const [showUsernamePrompt, setShowUsernamePrompt] = useState(true);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const storedUsername = await window.storage.get('username');
      if (storedUsername) {
        setUsername(storedUsername.value);
        setShowUsernamePrompt(false);
      }

      const result = await window.storage.list('board:');
      if (result && result.keys) {
        const boardData = await Promise.all(
          result.keys.map(async key => {
            const data = await window.storage.get(key);
            return data ? JSON.parse(data.value) : null;
          })
        );
        setBoards(boardData.filter(b => b !== null));
      }
    } catch (err) {
      console.log('No existing data found');
    }
  };

  const saveBoard = async (board) => {
    await window.storage.set(`board:${board.id}`, JSON.stringify(board));
  };

  const setUsernameAndSave = async (name) => {
    setUsername(name);
    await window.storage.set('username', name);
    setShowUsernamePrompt(false);
  };

  const addBoard = () => {
    if (!newBoardName.trim()) return;
    const board = {
      id: Date.now().toString(),
      name: newBoardName,
      lists: []
    };
    setBoards([...boards, board]);
    saveBoard(board);
    setNewBoardName('');
  };

  const addList = (boardId, listName) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: [...board.lists, { id: Date.now().toString(), name: listName, tasks: [] }]
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
  };

  const addTask = (boardId, listId, taskName) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: board.lists.map(list => {
            if (list.id === listId) {
              return {
                ...list,
                tasks: [...list.tasks, {
                  id: Date.now().toString(),
                  name: taskName,
                  subtasks: [],
                  labels: [],
                  assignees: [],
                  dueDate: null,
                  color: null,
                  expanded: false
                }]
              };
            }
            return list;
          })
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
  };

  const addSubtask = (boardId, listId, taskId, subtaskName) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: board.lists.map(list => {
            if (list.id === listId) {
              return {
                ...list,
                tasks: list.tasks.map(task => {
                  if (task.id === taskId) {
                    return {
                      ...task,
                      subtasks: [...task.subtasks, {
                        id: Date.now().toString(),
                        name: subtaskName,
                        completed: false
                      }]
                    };
                  }
                  return task;
                })
              };
            }
            return list;
          })
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
  };

  const toggleSubtask = (boardId, listId, taskId, subtaskId) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: board.lists.map(list => {
            if (list.id === listId) {
              return {
                ...list,
                tasks: list.tasks.map(task => {
                  if (task.id === taskId) {
                    return {
                      ...task,
                      subtasks: task.subtasks.map(st => 
                        st.id === subtaskId ? { ...st, completed: !st.completed } : st
                      )
                    };
                  }
                  return task;
                })
              };
            }
            return list;
          })
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
  };

  const updateTask = (boardId, listId, taskId, updates) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: board.lists.map(list => {
            if (list.id === listId) {
              return {
                ...list,
                tasks: list.tasks.map(task => 
                  task.id === taskId ? { ...task, ...updates } : task
                )
              };
            }
            return list;
          })
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
  };

  const deleteTask = (boardId, listId, taskId) => {
    const updatedBoards = boards.map(board => {
      if (board.id === boardId) {
        const updated = {
          ...board,
          lists: board.lists.map(list => {
            if (list.id === listId) {
              return {
                ...list,
                tasks: list.tasks.filter(task => task.id !== taskId)
              };
            }
            return list;
          })
        };
        saveBoard(updated);
        return updated;
      }
      return board;
    });
    setBoards(updatedBoards);
    setSelectedTask(null);
  };

  const deleteBoard = async (boardId) => {
    await window.storage.delete(`board:${boardId}`);
    setBoards(boards.filter(b => b.id !== boardId));
  };

  const TaskCard = ({ board, list, task }) => {
    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
    const totalSubtasks = task.subtasks.length;

    return (
      <div
        className={`p-3 rounded border-2 cursor-pointer hover:shadow-md transition-shadow ${
          task.color ? task.color : 'bg-white border-gray-200'
        }`}
        onClick={() => setSelectedTask({ board, list, task })}
      >
        <div className="font-medium mb-2">{task.name}</div>
        
        {task.labels.length > 0 && (
          <div className="flex flex-wrap gap-1 mb-2">
            {task.labels.map((label, idx) => (
              <span key={idx} className="text-xs px-2 py-1 bg-gray-200 rounded">
                {label}
              </span>
            ))}
          </div>
        )}

        <div className="flex items-center gap-3 text-sm text-gray-600">
          {totalSubtasks > 0 && (
            <span className="flex items-center gap-1">
              <ChevronRight size={14} />
              {completedSubtasks}/{totalSubtasks}
            </span>
          )}
          
          {task.dueDate && (
            <span className="flex items-center gap-1">
              <Clock size={14} />
              {new Date(task.dueDate).toLocaleDateString()}
            </span>
          )}

          {task.assignees.length > 0 && (
            <span className="flex items-center gap-1">
              <User size={14} />
              {task.assignees.length}
            </span>
          )}
        </div>
      </div>
    );
  };

  const TaskModal = ({ board, list, task, onClose }) => {
    const [newSubtask, setNewSubtask] = useState('');
    const [newLabel, setNewLabel] = useState('');
    const [newAssignee, setNewAssignee] = useState('');

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="p-6">
            <div className="flex justify-between items-start mb-4">
              <h2 className="text-2xl font-bold">{task.name}</h2>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>

            <div className="space-y-6">
              {/* Color Selection */}
              <div>
                <label className="block text-sm font-medium mb-2">Card Color</label>
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => updateTask(board.id, list.id, task.id, { color: null })}
                    className={`w-10 h-10 rounded border-2 ${!task.color ? 'border-blue-500' : 'border-gray-300'} bg-white`}
                  />
                  {COLORS.map(color => (
                    <button
                      key={color.name}
                      onClick={() => updateTask(board.id, list.id, task.id, { color: color.value })}
                      className={`w-10 h-10 rounded border-2 ${
                        task.color === color.value ? 'border-blue-500' : 'border-gray-300'
                      } ${color.value}`}
                    />
                  ))}
                </div>
              </div>

              {/* Due Date */}
              <div>
                <label className="block text-sm font-medium mb-2">Due Date</label>
                <input
                  type="date"
                  value={task.dueDate || ''}
                  onChange={(e) => updateTask(board.id, list.id, task.id, { dueDate: e.target.value })}
                  className="border rounded px-3 py-2 w-full"
                />
              </div>

              {/* Labels */}
              <div>
                <label className="block text-sm font-medium mb-2">Labels</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {task.labels.map((label, idx) => (
                    <span key={idx} className="px-3 py-1 bg-gray-200 rounded flex items-center gap-2">
                      {label}
                      <button
                        onClick={() => updateTask(board.id, list.id, task.id, {
                          labels: task.labels.filter((_, i) => i !== idx)
                        })}
                        className="text-gray-600 hover:text-red-600"
                      >
                        <X size={14} />
                      </button>
                    </span>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newLabel}
                    onChange={(e) => setNewLabel(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && newLabel.trim()) {
                        updateTask(board.id, list.id, task.id, {
                          labels: [...task.labels, newLabel]
                        });
                        setNewLabel('');
                      }
                    }}
                    placeholder="Add label..."
                    className="border rounded px-3 py-2 flex-1"
                  />
                  <button
                    onClick={() => {
                      if (newLabel.trim()) {
                        updateTask(board.id, list.id, task.id, {
                          labels: [...task.labels, newLabel]
                        });
                        setNewLabel('');
                      }
                    }}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    <Tag size={18} />
                  </button>
                </div>
              </div>

              {/* Assignees */}
              <div>
                <label className="block text-sm font-medium mb-2">Assigned To</label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {task.assignees.map((assignee, idx) => (
                    <span key={idx} className="px-3 py-1 bg-blue-100 rounded flex items-center gap-2">
                      {assignee}
                      <button
                        onClick={() => updateTask(board.id, list.id, task.id, {
                          assignees: task.assignees.filter((_, i) => i !== idx)
                        })}
                        className="text-gray-600 hover:text-red-600"
                      >
                        <X size={14} />
                      </button>
                    </span>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newAssignee}
                    onChange={(e) => setNewAssignee(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && newAssignee.trim()) {
                        updateTask(board.id, list.id, task.id, {
                          assignees: [...task.assignees, newAssignee]
                        });
                        setNewAssignee('');
                      }
                    }}
                    placeholder="Add person..."
                    className="border rounded px-3 py-2 flex-1"
                  />
                  <button
                    onClick={() => {
                      if (newAssignee.trim()) {
                        updateTask(board.id, list.id, task.id, {
                          assignees: [...task.assignees, newAssignee]
                        });
                        setNewAssignee('');
                      }
                    }}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    <User size={18} />
                  </button>
                </div>
              </div>

              {/* Subtasks */}
              <div>
                <label className="block text-sm font-medium mb-2">Subtasks</label>
                <div className="space-y-2 mb-2">
                  {task.subtasks.map(subtask => (
                    <div key={subtask.id} className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={subtask.completed}
                        onChange={() => toggleSubtask(board.id, list.id, task.id, subtask.id)}
                        className="w-4 h-4"
                      />
                      <span className={subtask.completed ? 'line-through text-gray-500' : ''}>
                        {subtask.name}
                      </span>
                    </div>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newSubtask}
                    onChange={(e) => setNewSubtask(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && newSubtask.trim()) {
                        addSubtask(board.id, list.id, task.id, newSubtask);
                        setNewSubtask('');
                      }
                    }}
                    placeholder="Add subtask..."
                    className="border rounded px-3 py-2 flex-1"
                  />
                  <button
                    onClick={() => {
                      if (newSubtask.trim()) {
                        addSubtask(board.id, list.id, task.id, newSubtask);
                        setNewSubtask('');
                      }
                    }}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    <Plus size={18} />
                  </button>
                </div>
              </div>

              {/* Delete Task */}
              <button
                onClick={() => deleteTask(board.id, list.id, task.id)}
                className="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 flex items-center justify-center gap-2"
              >
                <Trash2 size={18} />
                Delete Task
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  if (showUsernamePrompt) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
          <h1 className="text-3xl font-bold mb-4 text-gray-800">Welcome!</h1>
          <p className="text-gray-600 mb-6">Enter your name to get started</p>
          <input
            type="text"
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && username.trim() && setUsernameAndSave(username)}
            placeholder="Your name..."
            className="border-2 rounded px-4 py-3 w-full mb-4 text-lg"
            autoFocus
          />
          <button
            onClick={() => username.trim() && setUsernameAndSave(username)}
            className="w-full px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium"
          >
            Continue
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="p-6">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold text-gray-800">Task Tracker</h1>
          <div className="text-sm text-gray-600">Welcome, {username}</div>
        </div>

        <div className="mb-6 flex gap-2">
          <input
            type="text"
            value={newBoardName}
            onChange={(e) => setNewBoardName(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && addBoard()}
            placeholder="New board name..."
            className="border-2 rounded px-4 py-2 flex-1"
          />
          <button
            onClick={addBoard}
            className="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-2"
          >
            <Plus size={20} />
            Add Board
          </button>
        </div>

        <div className="space-y-6">
          {boards.map(board => (
            <div key={board.id} className="bg-white rounded-lg shadow-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">{board.name}</h2>
                <button
                  onClick={() => deleteBoard(board.id)}
                  className="text-red-500 hover:text-red-700"
                >
                  <Trash2 size={20} />
                </button>
              </div>

              <div className="flex gap-4 overflow-x-auto pb-4">
                {board.lists.map(list => (
                  <div key={list.id} className="bg-gray-100 rounded-lg p-4 min-w-[300px]">
                    <h3 className="font-semibold mb-3 text-lg">{list.name}</h3>
                    <div className="space-y-2 mb-3">
                      {list.tasks.map(task => (
                        <TaskCard key={task.id} board={board} list={list} task={task} />
                      ))}
                    </div>
                    <input
                      type="text"
                      placeholder="+ Add task..."
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && e.target.value.trim()) {
                          addTask(board.id, list.id, e.target.value);
                          e.target.value = '';
                        }
                      }}
                      className="w-full border rounded px-3 py-2 text-sm"
                    />
                  </div>
                ))}

                <div className="min-w-[300px]">
                  <input
                    type="text"
                    placeholder="+ Add list..."
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && e.target.value.trim()) {
                        addList(board.id, e.target.value);
                        e.target.value = '';
                      }
                    }}
                    className="w-full border-2 border-dashed rounded px-3 py-2 bg-gray-50"
                  />
                </div>
              </div>
            </div>
          ))}
        </div>

        {boards.length === 0 && (
          <div className="text-center text-gray-500 mt-12">
            <p className="text-xl">No boards yet. Create one to get started!</p>
          </div>
        )}
      </div>

      {selectedTask && (
        <TaskModal
          board={selectedTask.board}
          list={selectedTask.list}
          task={selectedTask.task}
          onClose={() => setSelectedTask(null)}
        />
      )}
    </div>
  );
}
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TaskTracker />);
    </script>
</body>
</html>